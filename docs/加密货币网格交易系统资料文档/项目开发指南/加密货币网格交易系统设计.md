以下是根据你的需求和技术栈重新整理的加密货币网格交易系统设计文档，基于“多 Docker 单 Hummingbot 实例”方案，重写了部分内容以确保一致性和清晰性。文档保留了你的核心功能需求和技术栈，优化了架构设计和实现细节。

---

# 加密货币网格交易系统设计文档

## 1. 系统概述

### 1.1 背景与目标

本系统是一款面向加密货币交易者的网格交易平台，旨在通过自动化“低买高卖”策略，帮助用户在波动市场中获取收益。系统注重安全性、灵活性和实时性，提供动态策略管理、多层风控和用户运营支持，适用于个人投资者和机构用户。

### 1.2 核心特点

- **动态策略管理**：支持运行时调整策略参数和数量，无需重启。
- **多策略支持**：同时运行多个交易所、多个交易对的网格策略。
- **智能交易机制**：基于反弹开仓和回调平仓，避免追涨杀跌。
- **多层风控**：提供单层和全局风控，保障交易安全。
- **商业化支持**：集成注册登录，用户管理、计费和代理分润功能。用成熟的解决方案，如Django。

### 1.3 应用场景

- 中短期震荡行情的网格交易。
- 实时调整参数以适应市场变化。
- 批量管理多策略组合。
- 支持代理推广和佣金分成模式。

---

## 2. 需要实现的功能及原因

### 2.1 网格策略核心

| 功能           | 详细说明                         | 实现原因                   |
| -------------- | -------------------------------- | -------------------------- |
| 三种网格类型   | 支持等差、等比和自定义网格       | 适应不同市场波动特性       |
| 反弹/回调机制  | 基于价格极值的反弹开仓和回调平仓 | 提升交易质量，避免追涨杀跌 |
| 动态网格调整   | 运行中调整区间、层数和参数       | 灵活应对市场变化，无需中断 |
| 独立网格层管理 | 每层独立设置参数，可增删层       | 提供最大定制化灵活性       |
| 批量策略管理   | 分组管理和批量操作多个策略       | 提升多策略管理效率         |

### 2.2 风控系统

| 功能          | 详细说明                       | 实现原因             |
| ------------- | ------------------------------ | -------------------- |
| 多维度风控    | 基于价格、金额、均价、技术指标 | 全方位保护资金安全   |
| 单层/全局风控 | 针对单层网格或整体策略的风控   | 实现精细化风险控制   |
| 风控条件组合  | 支持与/或逻辑组合多个条件      | 支持复杂风控策略     |
| 风控模板      | 保存和加载风控配置模板         | 提高配置效率和标准化 |

### 2.3 用户与计费系统

| 功能         | 详细说明                     | 实现原因                   |
| ------------ | ---------------------------- | -------------------------- |
| 三级用户结构 | 管理员、代理、普通用户       | 支持多级管理和营销         |
| 盈利计费     | 按策略盈利比例收费，定期结算 | 绑定用户利益，鼓励长期使用 |
| 账户余额管理 | 预付费模式，余额不足自动暂停 | 确保系统可持续运营         |
| 代理分润     | 代理招募下线并获取返佣       | 激励推广，扩大用户群       |

### 2.4 数据分析与监控

| 功能         | 详细说明                   | 实现原因           |
| ------------ | -------------------------- | ------------------ |
| 实时交易监控 | 显示策略状态、持仓、盈亏等 | 及时掌握运行情况   |
| 历史交易分析 | 交易记录查询、筛选和导出   | 分析表现，优化策略 |
| 绩效指标计算 | 收益率、胜率、最大回撤等   | 评估策略效果       |
| 资金曲线     | 可视化账户价值变化         | 直观展示绩效       |

---

## 3. 技术栈选择及作用

### 3.1 客户端技术栈

| 技术           | 版本   | 作用                                 |
| -------------- | ------ | ------------------------------------ |
| Electron       | 24+    | 跨平台桌面应用框架，提供本地化能力   |
| Vue 3          | 3.3+   | 响应式 UI 框架，构建现代化用户界面   |
| TypeScript     | 5.0+   | 提供类型安全，减少运行时错误         |
| Ant Design Vue | 4.0+   | 专业 UI 组件库，提供丰富交互组件     |
| Python         | 3.10+  | 交易核心引擎，处理网格策略和风控逻辑 |
| SQLite         | 最新版 | 本地数据存储，保存策略和交易记录     |
| python-shell   | -      | Electron 与 Python 通信桥接          |
| ECharts        | 5.4+   | 数据可视化图表库，展示网格和资金曲线 |
| Pinia          | 2.1+   | Vue 状态管理库，处理复杂应用状态     |
| Vite           | 4.0+   | 现代前端构建工具，提供快速开发体验   |
| Docker         | 最新版 | 容器化部署，隔离依赖并简化分发       |

### 3.2 服务端技术栈

| 技术                  | 版本     | 作用                             |
| --------------------- | -------- | -------------------------------- |
| Django                | 4.2+ LTS | 后端 Web 框架，处理业务逻辑      |
| Django REST Framework | 3.14+    | RESTful API 框架，提供 API 接口  |
| PostgreSQL            | 15+      | 关系型数据库，存储用户和交易数据 |
| Redis                 | 7.0+     | 缓存和消息队列，提高性能         |
| Celery                | 5.3+     | 异步任务队列，处理计费和报表生成 |
| Django Channels       | 4.0+     | WebSocket 支持，实现实时通信     |
| JWT                   | -        | 身份验证，保障 API 安全          |
| Docker                | 最新版   | 容器化部署，简化环境配置         |
| Nginx                 | 最新版   | Web 服务器和反向代理             |

### 3.3 Hummingbot 组件

| 组件         | 作用                                 |
| ------------ | ------------------------------------ |
| 交易所连接器 | 统一交易所 API 接口，支持 40+ 交易所 |
| 订单管理系统 | 处理订单创建、跟踪和状态更新         |
| 钱包管理     | 安全管理 API 密钥和账户连接          |
| 市场数据引擎 | 获取和处理实时市场数据               |

---

## 4. 系统架构设计

### 4.1 总体架构

```
┌───────────────────────────────────────────────────────────────┐
│                       主客户端容器                            │
│  ┌─────────────┐         ┌──────────────────┐                │
│  │ Electron+Vue│◄─────►  │ Python核心引擎   │                │
│  │  (UI层)     │         │ (网格策略/风控)  │                │
│  └─────────────┘         └────────┬─────────┘                │
│                                   ▼                          │
│                            Hummingbot管理器                  │
│                                   │                          │
└───────────────────────────────────┼──────────────────────────┘
                                    ▼
┌──────────────────────┬────────────┼────────────┬──────────────┐
│                      │            │            │              │
│  ┌──────────────┐   │  ┌─────────▼──┐   ┌─────▼─────┐  ┌─────▼─────┐
│  │ 交易所API    │◄────►│Hummingbot  │   │Hummingbot  │  │Hummingbot  │
│  │(市场数据/订单)│   │  (策略1)     │   │(策略2)     │  │(策略N)     │
│  └──────────────┘   │  └────────────┘   └───────────┘  └───────────┘
│                      │      Docker容器       Docker容器     Docker容器
└──────────────────────┘            │
                                    ▼
┌───────────────────────────────────┼────────────────────────────┐
│                                   ▼                            │
│                          服务端API                            │
│  ┌───────────────────────┐     ┌───────────────────────┐     │
│  │     Django API        │◄───►│ PostgreSQL + Redis    │     │
│  └───────────────────────┘     └──────────┬────────────┘     │
└───────────────────────────────────────────┼───────────────────┘
                                            ▼
┌───────────────────────────────────────────┼───────────────────┐
│                                           ▼                   │
│                                 管理员/代理用户                │
└───────────────────────────────────────────────────────────────┘
```

- **主客户端容器**：运行 Electron 前端（Vue3 UI）、Python 核心引擎（网格策略逻辑）和 Hummingbot 管理器，负责用户交互和策略管理。
- **Hummingbot 容器**：动态创建的多个容器，每个运行一个 Hummingbot 实例，作为交易执行器连接交易所。
- **服务端**：Django 提供 API 和 WebSocket 服务，管理用户数据和计费。

### 4.2 客户端详细架构

```
┌───────────────────────────────────────────────────────────────┐
│                       主客户端容器                            │
│                                                               │
│  ┌──────────────────────────────────────────────────────┐     │
│  │                Electron 渲染进程 (Vue3)              │     │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐     │     │
│  │  │ 策略管理   │  │ 网格配置   │  │ 风控设置   │     │     │
│  │  └────────────┘  └────────────┘  └────────────┘     │     │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐     │     │
│  │  │ 交易记录   │  │ 统计分析   │  │ 账户设置   │     │     │
│  │  └────────────┘  └────────────┘  └────────────┘     │     │
│  │  ┌────────────┐  ┌────────────┐                     │     │
│  │  │ Pinia状态  │  │ Vue Router │                     │     │
│  │  └────────────┘  └────────────┘                     │     │
│  └──────────────────────────────┬──────────────────────┘     │
│                                 ▼                            │
│  ┌──────────────────────────────┬──────────────────────┐     │
│  │            Electron 主进程   │                      │     │
│  │  ┌────────────┐  ┌───────────▼──────────┐           │     │
│  │  │ IPC通信    │  │ Python桥接(Node-Python)│         │     │
│  │  └────────────┘  └───────────┬──────────┘           │     │
│  └──────────────────────────────┼──────────────────────┘     │
│                                 ▼                            │
│  ┌──────────────────────────────┬──────────────────────┐     │
│  │           Python核心引擎     │                      │     │
│  │  ┌────────────┐  ┌───────────▼──────────┐ ┌────────┐     │
│  │  │网格策略引擎│  │ 风控系统            │ │数据管理│     │
│  │  │• 计算逻辑  │  │ • 条件/规则         │ │• SQLite│     │
│  │  │• 反弹/回调│  │ • 触发动作          │ │• 同步  │     │
│  │  └────────────┘  └───────────┬─────────┘ └────────┘     │
│  └──────────────────────────────┼──────────────────────┘     │
│                                 ▼                            │
│  ┌──────────────────────────────┬──────────────────────┐     │
│  │         Hummingbot管理器     │                      │     │
│  │  • 动态创建/销毁容器         │                      │     │
│  │  • 配置生成与分发            │                      │     │
│  └──────────────────────────────┼──────────────────────┘     │
└─────────────────────────────────┼────────────────────────────┘
                                  ▼
┌─────────────────────────────────┼────────────────────────────┐
│                                 ▼                            │
│  ┌────────────────────┐ ┌───────┴───────┐ ┌────────────┐    │
│  │Hummingbot容器(策略1)│ │Hummingbot(策略2)│ │Hummingbot(N)│    │
│  └────────────────────┘ └───────────────┘ └────────────┘    │
└─────────────────────────────────────────────────────────────┘
```

- **Electron 渲染进程**：Vue3 构建 UI，展示策略状态、网格配置和监控数据。
- **Electron 主进程**：通过 IPC 和 python-shell 与 Python 引擎通信。
- **Python 核心引擎**：实现网格策略逻辑和风控，调用 Hummingbot 管理器。
- **Hummingbot 管理器**：动态管理 Hummingbot 容器，生成配置文件并分配任务。

---

## 5. 数据流设计

### 5.1 客户端内部数据流

```
┌────────────┐     ┌────────────┐     ┌────────────┐     ┌────────────┐
│   Vue3 UI  │     │ Python引擎 │     │Hummingbot  │     │Hummingbot  │
│            │     │            │     │  管理器    │     │  容器      │
└─────┬──────┘     └─────┬──────┘     └─────┬──────┘     └─────┬──────┘
      │                   │                  │                  │
 1. 配置策略             │                  │                  │
──────┼─────────────────>│                  │                  │
      │             2. 生成配置             │                  │
      │                   ├─────────────────>│                  │
      │                   │            3. 创建容器             │
      │                   │                  ├─────────────────>│
      │                   │                  │            4. 执行交易
      │                   │                  │                  ├──────┐
      │                   │                  │                  │      ▼
      │                   │                  │             ┌────┴─────┐
      │                   │                  │             │ 交易所API │
      │                   │                  │             └────┬─────┘
      │                   │                  │            5. 交易结果
      │                   │             6. 处理结果         │<─────┘
      │                   │<─────────────────┤                  │
      │             7. 更新状态             │                  │
      │<──────────────────┤                  │                  │
      │                   │                  │                  │
```

1. 用户通过 Vue3 UI 创建策略（选择交易所和交易对）。
2. Python 引擎生成配置文件。
3. Hummingbot 管理器创建新容器并分发配置。
4. Hummingbot 容器执行交易。
5. 交易结果反馈至管理器。
6. Python 引擎处理结果。
7. 更新 UI 显示。

### 5.2 客户端-服务端通信流

```
┌────────────┐                          ┌────────────┐
│  客户端    │                          │  服务端    │
└─────┬──────┘                          └─────┬──────┘
      │                                       │
 1. 用户认证请求                            │
──────┼─────────────────────────────────────>│
      │                                 2. 返回令牌
      │<─────────────────────────────────────┤
      │                                       │
 3. 发送策略状态                            │
──────┼─────────────────────────────────────>│
      │                                 4. 计费处理
      │<─────────────────────────────────────┤
      │                                       │
 5. WebSocket实时通知                       │
──────┼──────────双向通信───────────────────>│
      │                                       │
```

- **认证**：客户端通过 JWT 与服务端认证。
- **数据同步**：定期发送策略状态至服务端。
- **实时通信**：通过 Django Channels 接收通知。

---

## 6. Hummingbot 与 Docker 实现

### 6.1 实现方案

- **多 Docker 单 Hummingbot 实例**：
  - 每个 Hummingbot 实例运行在独立 Docker 容器中，作为交易执行器。
  - 主客户端容器通过 Hummingbot 管理器动态创建/销毁容器。
  - 使用官方镜像 `hummingbot/hummingbot:latest`，避免依赖冲突。

### 6.2 Docker 配置

- **主客户端容器**：
  ```dockerfile
  # Dockerfile.client
  FROM node:20-slim AS builder
  WORKDIR /app
  COPY client/package.json client/package-lock.json ./
  RUN npm install
  COPY client/ ./
  RUN npm run build

  FROM python:3.10-slim
  WORKDIR /app
  RUN apt-get update && apt-get install -y libx11-xcb1 libgtk-3-0
  COPY client/requirements.txt ./
  RUN pip install -r requirements.txt
  COPY --from=builder /app/dist /app/dist
  COPY client/src/main /app/main
  COPY client/src/python /app/python
  CMD ["node", "main/index.js"]
  ```

- **Hummingbot 容器**（动态创建）：
  ```bash
  docker run -d --name hummingbot_$strategy_id \
    -v "$(pwd)/strategy_${strategy_id}_files:/conf" \
    hummingbot/hummingbot:latest
  ```

- **Docker Compose（开发）**：
  ```yaml
  version: "3.9"
  services:
    client:
      build: .
      volumes:
        - ./client:/app
      ports:
        - "3000:3000"
      networks:
        - trading-net
    hummingbot_manager:
      image: python:3.10-slim
      volumes:
        - ./hummingbot_manager:/app
      command: ["python", "/app/manager.py"]
      networks:
        - trading-net
  networks:
    trading-net:
  ```

---

## 7. 目录结构设计

### 7.1 客户端目录结构

```
client/
├── src/
│   ├── main/                        # Electron 主进程
│   │   ├── index.js                 # 主进程入口
│   │   ├── ipc.js                   # IPC 通信
│   │   └── python-bridge.js         # Python 桥接
│   ├── renderer/                    # Vue3 前端
│   │   ├── App.vue                  # 根组件
│   │   ├── main.js                  # 渲染进程入口
│   │   ├── components/              # 组件
│   │   │   ├── StrategyManager.vue  # 策略管理
│   │   │   ├── GridConfig.vue       # 网格配置
│   │   │   └── RiskSettings.vue     # 风控设置
│   │   ├── store/                   # Pinia 状态
│   │   │   ├── strategy.js          # 策略状态
│   │   └── router/                  # Vue 路由
│   │       └── index.js             # 路由配置
│   ├── python/                      # Python 核心引擎
│   │   ├── main.py                  # 引擎入口
│   │   ├── core/                    # 核心逻辑
│   │   │   ├── grid_manager.py      # 网格管理
│   │   │   ├── risk_controller.py   # 风控系统
│   │   │   └── data_manager.py      # 数据管理
│   │   └── hummingbot_manager.py    # Hummingbot 管理器
├── Dockerfile.client                # 主容器配置
├── docker-compose.yml               # 开发环境配置
└── requirements.txt                 # Python 依赖
```

### 7.2 服务端目录结构

```
server/
├── tradingsystem/
│   ├── config/
│   │   ├── settings/
│   │   │   ├── base.py              # 基础设置
│   │   │   └── prod.py              # 生产设置
│   │   └── urls.py                  # URL 配置
│   ├── apps/
│   │   ├── accounts/                # 用户管理
│   │   ├── strategies/              # 策略管理
│   │   ├── billing/                 # 计费系统
│   │   └── analytics/               # 数据分析
│   ├── api/
│   │   ├── v1/
│   │   │   ├── views.py             # API 视图
│   │   │   └── serializers.py       # API 序列化
├── Dockerfile                       # 服务端容器配置
├── docker-compose.yml               # 服务端部署配置
└── requirements/
    ├── base.txt                     # 基础依赖
    └── prod.txt                     # 生产依赖
```

---

## 8. 开发与分发

- **开发环境**：
  - 使用 `docker-compose up --build` 启动主客户端和 Hummingbot 管理器。
- **分发方式**：
  - 导出镜像：`docker save -o trading-system.tar my-trading-client:latest`
  - 提供启动脚本：
    ```bash
    # start.sh
    docker run -d --name client -p 3000:3000 my-trading-client:latest
    docker run -d --name hummingbot_manager python:3.10-slim python /app/manager.py
    ```

---

## 9. 资源需求与限制

- **2 核 4GB 服务器**：
  - 主客户端：500MB 内存，0.8 核 CPU。
  - 每个 Hummingbot 容器：200-400MB 内存，0.2-0.4 核 CPU。
  - 支持 3-6 个策略。
- **优化建议**：
  - 使用资源限制（`--memory` 和 `--cpus`）。
  - 预创建容器池，减少启动延迟。

---

这份文档基于“多 Docker 单 Hummingbot 实例”方案，优化了技术实现细节，确保与你的需求和技术栈一致。如果需要进一步细化某部分（例如 `hummingbot_manager.py` 实现或服务端 API 设计），请告诉我！