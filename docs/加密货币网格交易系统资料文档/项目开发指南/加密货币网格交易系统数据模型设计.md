# 加密货币网格交易系统数据模型设计

## 1. 概述

本文档详细描述加密货币网格交易系统的数据模型设计，包括客户端本地数据库和服务端中央数据库。设计遵循以下原则：

- **职责分离**：严格区分客户端和服务端数据存储内容，确保安全性
- **数据规范化**：遵循数据库设计范式，减少冗余、提高一致性
- **高效查询**：为常用操作设计适当索引，优化查询性能
- **数据安全**：敏感数据加密存储，保护用户资产安全
- **可扩展性**：设计支持未来功能扩展，避免大规模重构

## 2. 客户端数据模型 (SQLite)

### 2.1 本地策略配置表 (local_strategies)

存储用户在本地配置的交易策略信息。

| 字段名                | 类型      | 描述             | 索引 | 备注                                 |
| --------------------- | --------- | ---------------- | ---- | ------------------------------------ |
| id                    | TEXT      | 策略UUID         | 主键 |                                      |
| name                  | TEXT      | 策略名称         |      |                                      |
| exchange_id           | TEXT      | 交易所ID         | 外键 | 关联local_exchange_accounts          |
| trading_pair          | TEXT      | 交易对           |      | 例如 "BTC/USDT"                      |
| grid_type             | TEXT      | 网格类型         |      | "arithmetic"/"geometric"/"custom"    |
| direction             | TEXT      | 交易方向         |      | "long"/"short"                       |
| upper_price           | REAL      | 上限价格         |      |                                      |
| lower_price           | REAL      | 下限价格         |      |                                      |
| grid_levels           | INTEGER   | 网格层数         |      |                                      |
| investment_amount     | REAL      | 投资金额         |      |                                      |
| default_grid_spread   | REAL      | 默认网格间距     |      | 百分比值                             |
| default_take_profit   | REAL      | 默认止盈比例     |      | 百分比值                             |
| default_open_rebound  | REAL      | 默认开仓反弹比例 |      | 百分比值                             |
| default_close_rebound | REAL      | 默认平仓反弹比例 |      | 百分比值                             |
| status                | TEXT      | 策略状态         |      | "running"/"stopped"/"paused"/"error" |
| risk_controls         | TEXT      | 风控配置(JSON)   |      | 包含风控参数的JSON字符串             |
| created_at            | TIMESTAMP | 创建时间         |      |                                      |
| updated_at            | TIMESTAMP | 更新时间         |      |                                      |
| last_sync_at          | TIMESTAMP | 最后同步时间     |      | 与服务端同步的时间戳                 |
| is_deleted            | BOOLEAN   | 是否删除         |      | 逻辑删除标记                         |

创建语句：
```sql
CREATE TABLE local_strategies (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    exchange_id TEXT NOT NULL,
    trading_pair TEXT NOT NULL,
    grid_type TEXT NOT NULL,
    direction TEXT NOT NULL,
    upper_price REAL NOT NULL,
    lower_price REAL NOT NULL,
    grid_levels INTEGER NOT NULL,
    investment_amount REAL NOT NULL,
    default_grid_spread REAL NOT NULL,
    default_take_profit REAL NOT NULL,
    default_open_rebound REAL NOT NULL,
    default_close_rebound REAL NOT NULL,
    status TEXT NOT NULL,
    risk_controls TEXT,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    last_sync_at TIMESTAMP,
    is_deleted BOOLEAN NOT NULL DEFAULT 0,
    FOREIGN KEY (exchange_id) REFERENCES local_exchange_accounts(id)
);

CREATE INDEX idx_strategies_status ON local_strategies(status);
CREATE INDEX idx_strategies_exchange ON local_strategies(exchange_id);
```

### 2.2 网格层级表 (local_grid_levels)

存储每个策略的网格层级配置和状态。

| 字段名                | 类型      | 描述         | 索引 | 备注                                                     |
| --------------------- | --------- | ------------ | ---- | -------------------------------------------------------- |
| id                    | TEXT      | 层级UUID     | 主键 |                                                          |
| strategy_id           | TEXT      | 所属策略ID   | 外键 | 关联local_strategies                                     |
| sequence_number       | INTEGER   | 层级序号     |      | 从0开始                                                  |
| upper_price           | REAL      | 上限价格     |      |                                                          |
| lower_price           | REAL      | 下限价格     |      |                                                          |
| interval_percent      | REAL      | 网格间距     |      | 百分比值                                                 |
| take_profit_percent   | REAL      | 止盈比例     |      | 百分比值                                                 |
| open_rebound_percent  | REAL      | 开仓反弹比例 |      | 百分比值                                                 |
| close_rebound_percent | REAL      | 平仓反弹比例 |      | 百分比值                                                 |
| invest_amount         | REAL      | 投资金额     |      |                                                          |
| status                | TEXT      | 层级状态     |      | "unfilled"/"pending_open"/"filled"/"pending_tp"/"closed" |
| filled_price          | REAL      | 开仓价格     |      | 已开仓时的价格                                           |
| filled_amount         | REAL      | 开仓数量     |      | 已开仓的数量                                             |
| filled_value          | REAL      | 开仓价值     |      | 开仓价格×数量                                            |
| filled_at             | TIMESTAMP | 开仓时间     |      |                                                          |
| closed_price          | REAL      | 平仓价格     |      | 已平仓时的价格                                           |
| closed_amount         | REAL      | 平仓数量     |      | 已平仓的数量                                             |
| closed_value          | REAL      | 平仓价值     |      | 平仓价格×数量                                            |
| profit                | REAL      | 盈亏金额     |      |                                                          |
| closed_at             | TIMESTAMP | 平仓时间     |      |                                                          |
| is_deleted            | BOOLEAN   | 是否删除     |      | 逻辑删除标记                                             |

创建语句：
```sql
CREATE TABLE local_grid_levels (
    id TEXT PRIMARY KEY,
    strategy_id TEXT NOT NULL,
    sequence_number INTEGER NOT NULL,
    upper_price REAL NOT NULL,
    lower_price REAL NOT NULL,
    interval_percent REAL NOT NULL,
    take_profit_percent REAL NOT NULL,
    open_rebound_percent REAL NOT NULL,
    close_rebound_percent REAL NOT NULL,
    invest_amount REAL NOT NULL,
    status TEXT NOT NULL,
    filled_price REAL,
    filled_amount REAL,
    filled_value REAL,
    filled_at TIMESTAMP,
    closed_price REAL,
    closed_amount REAL,
    closed_value REAL,
    profit REAL,
    closed_at TIMESTAMP,
    is_deleted BOOLEAN NOT NULL DEFAULT 0,
    FOREIGN KEY (strategy_id) REFERENCES local_strategies(id),
    UNIQUE (strategy_id, sequence_number)
);

CREATE INDEX idx_grid_levels_strategy ON local_grid_levels(strategy_id);
CREATE INDEX idx_grid_levels_status ON local_grid_levels(status);
```

### 2.2.1 参数调整与历史追踪

```sql
CREATE TABLE local_parameter_changes (
    id TEXT PRIMARY KEY,
    strategy_id TEXT NOT NULL,
    parameter_name TEXT NOT NULL,
    old_value TEXT,
    new_value TEXT,
    changed_at TIMESTAMP NOT NULL,
    changed_by TEXT NOT NULL,
    is_effective BOOLEAN NOT NULL DEFAULT 1,
    affected_grid_levels TEXT, -- 逗号分隔的层级ID列表
    synchronized BOOLEAN NOT NULL DEFAULT 0,
    FOREIGN KEY (strategy_id) REFERENCES local_strategies(id)
);

CREATE INDEX idx_parameter_changes_strategy ON local_parameter_changes(strategy_id);
CREATE INDEX idx_parameter_changes_parameter ON local_parameter_changes(strategy_id, parameter_name);
```

```sql
CREATE TABLE agent_invitation_links (
    id UUID PRIMARY KEY,
    agent_id UUID NOT NULL,
    invitation_code VARCHAR(20) NOT NULL UNIQUE,
    custom_message TEXT,
    expire_at TIMESTAMP,
    max_uses INTEGER,
    used_count INTEGER NOT NULL DEFAULT 0,
    commission_override DECIMAL(5,2),
    active BOOLEAN NOT NULL DEFAULT TRUE,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
    FOREIGN KEY (agent_id) REFERENCES agents(id)
);

CREATE INDEX idx_invitation_links_agent ON agent_invitation_links(agent_id);
CREATE INDEX idx_invitation_links_code ON agent_invitation_links(invitation_code);
```

```sql
CREATE TABLE local_recovery_points (
    id TEXT PRIMARY KEY,
    strategy_id TEXT NOT NULL,
    timestamp TIMESTAMP NOT NULL,
    snapshot TEXT NOT NULL, -- JSON格式的完整策略状态
    status TEXT NOT NULL,
    metadata TEXT, -- 额外信息
    FOREIGN KEY (strategy_id) REFERENCES local_strategies(id)
);

CREATE INDEX idx_recovery_points_strategy ON local_recovery_points(strategy_id);
CREATE INDEX idx_recovery_points_timestamp ON local_recovery_points(timestamp);
```

### 2.3 风控条件表 (local_risk_controls)

存储用户配置的风险控制条件。

| 字段名           | 类型      | 描述           | 索引 | 备注                                                |
| ---------------- | --------- | -------------- | ---- | --------------------------------------------------- |
| id               | TEXT      | 条件UUID       | 主键 |                                                     |
| strategy_id      | TEXT      | 所属策略ID     | 外键 | 关联local_strategies                                |
| name             | TEXT      | 条件名称       |      |                                                     |
| weight           | INTEGER   | 条件权重       |      | 1-4的整数                                           |
| action_type      | TEXT      | 动作类型       |      | "open"/"close"                                      |
| direction        | TEXT      | 方向           |      | 开仓:"long"/"short", 平仓:"take_profit"/"stop_loss" |
| scope            | TEXT      | 范围           |      | "current_level"/"all_levels"                        |
| indicator        | TEXT      | 指标类型       |      | "avg_price"/"amount"/"technical"/"custom"           |
| indicator_params | TEXT      | 指标参数(JSON) |      | 例如技术指标的周期等                                |
| condition        | TEXT      | 条件类型       |      | "greater_than"/"less_than"/"equal"/"between"        |
| threshold        | REAL      | 阈值           |      |                                                     |
| threshold2       | REAL      | 第二阈值       |      | 用于between条件                                     |
| is_enabled       | BOOLEAN   | 是否启用       |      |                                                     |
| created_at       | TIMESTAMP | 创建时间       |      |                                                     |
| updated_at       | TIMESTAMP | 更新时间       |      |                                                     |

创建语句：
```sql
CREATE TABLE local_risk_controls (
    id TEXT PRIMARY KEY,
    strategy_id TEXT NOT NULL,
    name TEXT NOT NULL,
    is_enabled BOOLEAN NOT NULL DEFAULT 1,
    weight INTEGER NOT NULL,
    action_type TEXT NOT NULL,   -- "open"/"close"
    direction TEXT NOT NULL,     -- 开仓:"long"/"short", 平仓:"take_profit"/"stop_loss"
    scope TEXT NOT NULL,         -- "current_level"/"all_levels"
    range TEXT,                  -- UI中的"范围"字段
    indicator TEXT NOT NULL,     -- "avg_price"/"amount"/"technical"/"custom"
    indicator_params TEXT,       -- JSON格式的指标参数
    condition TEXT NOT NULL,     -- "greater_than"/"less_than"/"equal"/"between"
    threshold REAL NOT NULL,
    threshold2 REAL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (strategy_id) REFERENCES local_strategies(id)
);

CREATE INDEX idx_risk_controls_strategy ON local_risk_controls(strategy_id);
CREATE INDEX idx_risk_controls_enabled ON local_risk_controls(is_enabled);
```

### 2.4 交易所账户表 (local_exchange_accounts)

存储用户交易所API配置，API密钥采用加密存储。

| 字段名               | 类型      | 描述             | 索引 | 备注                   |
| -------------------- | --------- | ---------------- | ---- | ---------------------- |
| id                   | TEXT      | 账户UUID         | 主键 |                        |
| exchange             | TEXT      | 交易所代码       |      | "binance"/"okx"等      |
| name                 | TEXT      | 账户名称         |      | 用户自定义名称         |
| api_key_encrypted    | TEXT      | 加密的API Key    |      | 使用本地密钥加密       |
| api_secret_encrypted | TEXT      | 加密的API Secret |      | 使用本地密钥加密       |
| passphrase_encrypted | TEXT      | 加密的Passphrase |      | 部分交易所需要         |
| permissions          | TEXT      | 权限(JSON)       |      | 例如["spot","futures"] |
| created_at           | TIMESTAMP | 创建时间         |      |                        |
| updated_at           | TIMESTAMP | 更新时间         |      |                        |
| last_used_at         | TIMESTAMP | 最后使用时间     |      |                        |
| is_enabled           | BOOLEAN   | 是否启用         |      |                        |

创建语句：
```sql
CREATE TABLE local_exchange_accounts (
    id TEXT PRIMARY KEY,
    exchange TEXT NOT NULL,
    name TEXT NOT NULL,
    api_key_encrypted TEXT NOT NULL,
    api_secret_encrypted TEXT NOT NULL,
    passphrase_encrypted TEXT,
    permissions TEXT NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    last_used_at TIMESTAMP,
    is_enabled BOOLEAN NOT NULL DEFAULT 1
);

CREATE INDEX idx_exchange_accounts_exchange ON local_exchange_accounts(exchange);
CREATE INDEX idx_exchange_accounts_enabled ON local_exchange_accounts(is_enabled);
```

### 2.5 交易记录表 (local_trades)

存储策略执行的交易记录。

| 字段名            | 类型      | 描述         | 索引 | 备注                  |
| ----------------- | --------- | ------------ | ---- | --------------------- |
| id                | TEXT      | 交易UUID     | 主键 |                       |
| strategy_id       | TEXT      | 所属策略ID   | 外键 | 关联local_strategies  |
| grid_level_id     | TEXT      | 关联网格层ID | 外键 | 关联local_grid_levels |
| exchange_order_id | TEXT      | 交易所订单ID |      |                       |
| trade_type        | TEXT      | 交易类型     |      | "buy"/"sell"          |
| price             | REAL      | 成交价格     |      |                       |
| amount            | REAL      | 成交数量     |      |                       |
| value             | REAL      | 成交价值     |      | 价格×数量             |
| fee               | REAL      | 手续费       |      |                       |
| fee_currency      | TEXT      | 手续费币种   |      |                       |
| profit            | REAL      | 盈亏金额     |      | 对于卖出交易          |
| executed_at       | TIMESTAMP | 执行时间     |      |                       |
| synced            | BOOLEAN   | 是否已同步   |      | 是否已同步到服务端    |

创建语句：
```sql
CREATE TABLE local_trades (
    id TEXT PRIMARY KEY,
    strategy_id TEXT NOT NULL,
    grid_level_id TEXT NOT NULL,
    exchange_order_id TEXT NOT NULL,
    trade_type TEXT NOT NULL,
    price REAL NOT NULL,
    amount REAL NOT NULL,
    value REAL NOT NULL,
    fee REAL NOT NULL,
    fee_currency TEXT NOT NULL,
    profit REAL,
    executed_at TIMESTAMP NOT NULL,
    synced BOOLEAN NOT NULL DEFAULT 0,
    FOREIGN KEY (strategy_id) REFERENCES local_strategies(id),
    FOREIGN KEY (grid_level_id) REFERENCES local_grid_levels(id)
);

CREATE INDEX idx_trades_strategy ON local_trades(strategy_id);
CREATE INDEX idx_trades_executed_at ON local_trades(executed_at);
CREATE INDEX idx_trades_synced ON local_trades(synced);
```

### 2.6 本地日志表 (local_logs)

存储本地运行日志。

| 字段名      | 类型      | 描述           | 索引 | 备注                                        |
| ----------- | --------- | -------------- | ---- | ------------------------------------------- |
| id          | INTEGER   | 日志ID         | 主键 | 自增                                        |
| timestamp   | TIMESTAMP | 日志时间       |      |                                             |
| level       | TEXT      | 日志级别       |      | "DEBUG"/"INFO"/"WARNING"/"ERROR"/"CRITICAL" |
| component   | TEXT      | 组件名称       |      |                                             |
| message     | TEXT      | 日志消息       |      |                                             |
| details     | TEXT      | 详细信息(JSON) |      |                                             |
| strategy_id | TEXT      | 相关策略ID     |      | 可为NULL                                    |

创建语句：
```sql
CREATE TABLE local_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    timestamp TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    level TEXT NOT NULL,
    component TEXT NOT NULL,
    message TEXT NOT NULL,
    details TEXT,
    strategy_id TEXT,
    FOREIGN KEY (strategy_id) REFERENCES local_strategies(id)
);

CREATE INDEX idx_logs_timestamp ON local_logs(timestamp);
CREATE INDEX idx_logs_level ON local_logs(level);
CREATE INDEX idx_logs_strategy ON local_logs(strategy_id);
```

### 2.7 本地设置表 (local_settings)

存储客户端应用设置。

| 字段名     | 类型      | 描述     | 索引 | 备注 |
| ---------- | --------- | -------- | ---- | ---- |
| key        | TEXT      | 设置键   | 主键 |      |
| value      | TEXT      | 设置值   |      |      |
| updated_at | TIMESTAMP | 更新时间 |      |      |

创建语句：
```sql
CREATE TABLE local_settings (
    key TEXT PRIMARY KEY,
    value TEXT NOT NULL,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);
```

## 3. 服务端数据模型 (PostgreSQL)

### 3.1 用户表 (users)

存储系统用户信息。

| 字段名       | 类型         | 描述           | 索引 | 备注                   |
| ------------ | ------------ | -------------- | ---- | ---------------------- |
| id           | UUID         | 用户UUID       | 主键 |                        |
| username     | VARCHAR(150) | 用户名         | 唯一 |                        |
| email        | VARCHAR(254) | 电子邮箱       | 唯一 |                        |
| password     | VARCHAR(128) | 密码哈希       |      | 使用Django密码哈希     |
| first_name   | VARCHAR(150) | 名             |      |                        |
| last_name    | VARCHAR(150) | 姓             |      |                        |
| phone        | VARCHAR(20)  | 电话号码       |      |                        |
| is_active    | BOOLEAN      | 是否激活       |      |                        |
| is_staff     | BOOLEAN      | 是否员工       |      |                        |
| is_superuser | BOOLEAN      | 是否超级管理员 |      |                        |
| role         | VARCHAR(20)  | 角色           |      | "user"/"agent"/"admin" |
| date_joined  | TIMESTAMP    | 注册时间       |      |                        |
| last_login   | TIMESTAMP    | 最后登录时间   |      |                        |
| referrer_id  | UUID         | 推荐人ID       | 外键 | 关联users，可为NULL    |
| created_at   | TIMESTAMP    | 创建时间       |      |                        |
| updated_at   | TIMESTAMP    | 更新时间       |      |                        |

创建语句：
```sql
CREATE TABLE users (
    id UUID PRIMARY KEY,
    username VARCHAR(150) NOT NULL UNIQUE,
    email VARCHAR(254) NOT NULL UNIQUE,
    password VARCHAR(128) NOT NULL,
    first_name VARCHAR(150) NOT NULL,
    last_name VARCHAR(150) NOT NULL,
    phone VARCHAR(20),
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    is_staff BOOLEAN NOT NULL DEFAULT FALSE,
    is_superuser BOOLEAN NOT NULL DEFAULT FALSE,
    role VARCHAR(20) NOT NULL DEFAULT 'user',
    date_joined TIMESTAMP NOT NULL DEFAULT NOW(),
    last_login TIMESTAMP,
    referrer_id UUID,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
    FOREIGN KEY (referrer_id) REFERENCES users(id)
);

CREATE INDEX idx_users_role ON users(role);
CREATE INDEX idx_users_referrer ON users(referrer_id);
```

### 3.2 代理表 (agents)

存储代理用户的额外信息。

| 字段名           | 类型          | 描述     | 索引      | 备注                          |
| ---------------- | ------------- | -------- | --------- | ----------------------------- |
| id               | UUID          | 代理UUID | 主键      |                               |
| user_id          | UUID          | 用户ID   | 外键,唯一 | 关联users                     |
| agent_level      | INTEGER       | 代理级别 |           | 1/2/3级                       |
| agent_status     | VARCHAR(20)   | 代理状态 |           | "pending"/"active"/"inactive" |
| invitation_code  | VARCHAR(20)   | 邀请码   | 唯一      |                               |
| commission_rate  | DECIMAL(5,2)  | 佣金比例 |           | 百分比值                      |
| total_commission | DECIMAL(15,2) | 总佣金   |           |                               |
| approved_at      | TIMESTAMP     | 审批时间 |           |                               |
| approved_by      | UUID          | 审批人ID | 外键      | 关联users，可为NULL           |
| path             | VARCHAR(255)  | 代理路径 |           | 使用Materialized Path模式     |
| created_at       | TIMESTAMP     | 创建时间 |           |                               |
| updated_at       | TIMESTAMP     | 更新时间 |           |                               |

创建语句：
```sql
CREATE TABLE agents (
    id UUID PRIMARY KEY,
    user_id UUID NOT NULL UNIQUE,
    agent_level INTEGER NOT NULL,
    agent_status VARCHAR(20) NOT NULL,
    invitation_code VARCHAR(20) NOT NULL UNIQUE,
    commission_rate DECIMAL(5,2) NOT NULL,
    total_commission DECIMAL(15,2) NOT NULL DEFAULT 0.00,
    approved_at TIMESTAMP,
    approved_by UUID,
    path VARCHAR(255) NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (approved_by) REFERENCES users(id)
);

CREATE INDEX idx_agents_status ON agents(agent_status);
CREATE INDEX idx_agents_path ON agents(path);
```

### 3.3 自定义佣金率表 (custom_commission_rates)

存储代理为特定下线设置的自定义佣金率。

| 字段名          | 类型         | 描述       | 索引 | 备注       |
| --------------- | ------------ | ---------- | ---- | ---------- |
| id              | UUID         | 记录UUID   | 主键 |            |
| agent_id        | UUID         | 代理ID     | 外键 | 关联agents |
| downline_id     | UUID         | 下线用户ID | 外键 | 关联users  |
| commission_rate | DECIMAL(5,2) | 佣金比例   |      | 百分比值   |
| created_at      | TIMESTAMP    | 创建时间   |      |            |
| updated_at      | TIMESTAMP    | 更新时间   |      |            |

创建语句：
```sql
CREATE TABLE custom_commission_rates (
    id UUID PRIMARY KEY,
    agent_id UUID NOT NULL,
    downline_id UUID NOT NULL,
    commission_rate DECIMAL(5,2) NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
    FOREIGN KEY (agent_id) REFERENCES agents(id),
    FOREIGN KEY (downline_id) REFERENCES users(id),
    UNIQUE (agent_id, downline_id)
);

CREATE INDEX idx_custom_rates_agent ON custom_commission_rates(agent_id);
```

### 3.4 账户余额表 (account_balances)

存储用户账户余额。

| 字段名       | 类型          | 描述         | 索引      | 备注        |
| ------------ | ------------- | ------------ | --------- | ----------- |
| id           | UUID          | 记录UUID     | 主键      |             |
| user_id      | UUID          | 用户ID       | 外键,唯一 | 关联users   |
| balance      | DECIMAL(15,2) | 余额         |           |             |
| currency     | VARCHAR(10)   | 货币         |           | 默认 "USDT" |
| last_updated | TIMESTAMP     | 最后更新时间 |           |             |

创建语句：
```sql
CREATE TABLE account_balances (
    id UUID PRIMARY KEY,
    user_id UUID NOT NULL UNIQUE,
    balance DECIMAL(15,2) NOT NULL DEFAULT 0.00,
    currency VARCHAR(10) NOT NULL DEFAULT 'USDT',
    last_updated TIMESTAMP NOT NULL DEFAULT NOW(),
    FOREIGN KEY (user_id) REFERENCES users(id)
);

CREATE INDEX idx_balances_user ON account_balances(user_id);
```

### 3.5 交易流水表 (transactions)

记录用户账户的所有资金变动。

| 字段名           | 类型          | 描述       | 索引 | 备注                                      |
| ---------------- | ------------- | ---------- | ---- | ----------------------------------------- |
| id               | UUID          | 流水UUID   | 主键 |                                           |
| user_id          | UUID          | 用户ID     | 外键 | 关联users                                 |
| transaction_type | VARCHAR(20)   | 交易类型   |      | "deposit"/"fee"/"commission"/"withdrawal" |
| amount           | DECIMAL(15,2) | 金额       |      | 正数为收入，负数为支出                    |
| currency         | VARCHAR(10)   | 货币       |      | 默认 "USDT"                               |
| status           | VARCHAR(20)   | 状态       |      | "pending"/"completed"/"failed"            |
| reference        | VARCHAR(255)  | 参考信息   |      | 例如"Invoice INV-2023-001"                |
| balance_after    | DECIMAL(15,2) | 交易后余额 |      |                                           |
| created_at       | TIMESTAMP     | 创建时间   |      |                                           |
| completed_at     | TIMESTAMP     | 完成时间   |      | 可为NULL                                  |

创建语句：
```sql
CREATE TABLE transactions (
    id UUID PRIMARY KEY,
    user_id UUID NOT NULL,
    transaction_type VARCHAR(20) NOT NULL,
    amount DECIMAL(15,2) NOT NULL,
    currency VARCHAR(10) NOT NULL DEFAULT 'USDT',
    status VARCHAR(20) NOT NULL,
    reference VARCHAR(255),
    balance_after DECIMAL(15,2) NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    completed_at TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);

CREATE INDEX idx_transactions_user ON transactions(user_id);
CREATE INDEX idx_transactions_type ON transactions(transaction_type);
CREATE INDEX idx_transactions_created ON transactions(created_at);
```

### 3.6 账单表 (invoices)

存储系统结算产生的账单。

| 字段名                 | 类型          | 描述         | 索引 | 备注                                  |
| ---------------------- | ------------- | ------------ | ---- | ------------------------------------- |
| id                     | UUID          | 账单UUID     | 主键 |                                       |
| user_id                | UUID          | 用户ID       | 外键 | 关联users                             |
| invoice_number         | VARCHAR(20)   | 账单编号     | 唯一 | 例如"INV-2023-001"                    |
| billing_period_start   | TIMESTAMP     | 计费开始时间 |      |                                       |
| billing_period_end     | TIMESTAMP     | 计费结束时间 |      |                                       |
| total_trading_volume   | DECIMAL(15,2) | 总交易量     |      |                                       |
| total_trades_count     | INTEGER       | 总交易次数   |      |                                       |
| total_strategies_count | INTEGER       | 策略数量     |      |                                       |
| total_profit           | DECIMAL(15,2) | 总盈利       |      |                                       |
| fee_rate               | DECIMAL(5,2)  | 费率         |      | 百分比值                              |
| fee_amount             | DECIMAL(15,2) | 费用金额     |      |                                       |
| discount_percentage    | DECIMAL(5,2)  | 折扣百分比   |      |                                       |
| discount_amount        | DECIMAL(15,2) | 折扣金额     |      |                                       |
| payable_amount         | DECIMAL(15,2) | 应付金额     |      |                                       |
| status                 | VARCHAR(20)   | 状态         |      | "pending"/"paid"/"overdue"/"canceled" |
| payment_method         | VARCHAR(20)   | 支付方式     |      | "auto-deduction"/"crypto_transfer"    |
| payment_date           | TIMESTAMP     | 支付日期     |      | 可为NULL                              |
| created_at             | TIMESTAMP     | 创建时间     |      |                                       |
| updated_at             | TIMESTAMP     | 更新时间     |      |                                       |

创建语句：
```sql
CREATE TABLE invoices (
    id UUID PRIMARY KEY,
    user_id UUID NOT NULL,
    invoice_number VARCHAR(20) NOT NULL UNIQUE,
    billing_period_start TIMESTAMP NOT NULL,
    billing_period_end TIMESTAMP NOT NULL,
    total_trading_volume DECIMAL(15,2) NOT NULL DEFAULT 0.00,
    total_trades_count INTEGER NOT NULL DEFAULT 0,
    total_strategies_count INTEGER NOT NULL DEFAULT 0,
    total_profit DECIMAL(15,2) NOT NULL DEFAULT 0.00,
    fee_rate DECIMAL(5,2) NOT NULL,
    fee_amount DECIMAL(15,2) NOT NULL,
    discount_percentage DECIMAL(5,2) NOT NULL DEFAULT 0.00,
    discount_amount DECIMAL(15,2) NOT NULL DEFAULT 0.00,
    payable_amount DECIMAL(15,2) NOT NULL,
    status VARCHAR(20) NOT NULL,
    payment_method VARCHAR(20),
    payment_date TIMESTAMP,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
    FOREIGN KEY (user_id) REFERENCES users(id)
);

CREATE INDEX idx_invoices_user ON invoices(user_id);
CREATE INDEX idx_invoices_status ON invoices(status);
CREATE INDEX idx_invoices_billing_period ON invoices(billing_period_start, billing_period_end);
```

### 3.7 账单明细表 (invoice_details)

存储账单中的策略明细。

| 字段名         | 类型          | 描述     | 索引 | 备注         |
| -------------- | ------------- | -------- | ---- | ------------ |
| id             | UUID          | 明细UUID | 主键 |              |
| invoice_id     | UUID          | 账单ID   | 外键 | 关联invoices |
| strategy_id    | UUID          | 策略ID   |      |              |
| strategy_name  | VARCHAR(100)  | 策略名称 |      |              |
| trading_volume | DECIMAL(15,2) | 交易量   |      |              |
| trades_count   | INTEGER       | 交易次数 |      |              |
| profit         | DECIMAL(15,2) | 盈利     |      |              |
| fee_amount     | DECIMAL(15,2) | 费用金额 |      |              |

创建语句：
```sql
CREATE TABLE invoice_details (
    id UUID PRIMARY KEY,
    invoice_id UUID NOT NULL,
    strategy_id UUID NOT NULL,
    strategy_name VARCHAR(100) NOT NULL,
    trading_volume DECIMAL(15,2) NOT NULL,
    trades_count INTEGER NOT NULL,
    profit DECIMAL(15,2) NOT NULL,
    fee_amount DECIMAL(15,2) NOT NULL,
    FOREIGN KEY (invoice_id) REFERENCES invoices(id)
);

CREATE INDEX idx_invoice_details_invoice ON invoice_details(invoice_id);
```

### 3.8 佣金记录表 (commissions)

记录代理获得的佣金。

| 字段名            | 类型          | 描述             | 索引 | 备注             |
| ----------------- | ------------- | ---------------- | ---- | ---------------- |
| id                | UUID          | 佣金记录UUID     | 主键 |                  |
| agent_id          | UUID          | 代理ID           | 外键 | 关联agents       |
| source_user_id    | UUID          | 产生佣金的用户ID | 外键 | 关联users        |
| source_invoice_id | UUID          | 相关账单ID       | 外键 | 关联invoices     |
| commission_level  | INTEGER       | 佣金级别         |      |                  |
| commission_rate   | DECIMAL(5,2)  | 佣金比例         |      | 百分比值         |
| base_amount       | DECIMAL(15,2) | 基础金额         |      |                  |
| commission_amount | DECIMAL(15,2) | 佣金金额         |      |                  |
| status            | VARCHAR(20)   | 状态             |      | "pending"/"paid" |
| created_at        | TIMESTAMP     | 创建时间         |      |                  |
| paid_at           | TIMESTAMP     | 支付时间         |      | 可为NULL         |

创建语句：
```sql
CREATE TABLE commissions (
    id UUID PRIMARY KEY,
    agent_id UUID NOT NULL,
    source_user_id UUID NOT NULL,
    source_invoice_id UUID NOT NULL,
    commission_level INTEGER NOT NULL,
    commission_rate DECIMAL(5,2) NOT NULL,
    base_amount DECIMAL(15,2) NOT NULL,
    commission_amount DECIMAL(15,2) NOT NULL,
    status VARCHAR(20) NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    paid_at TIMESTAMP,
    FOREIGN KEY (agent_id) REFERENCES agents(id),
    FOREIGN KEY (source_user_id) REFERENCES users(id),
    FOREIGN KEY (source_invoice_id) REFERENCES invoices(id)
);

CREATE INDEX idx_commissions_agent ON commissions(agent_id);
CREATE INDEX idx_commissions_status ON commissions(status);
CREATE INDEX idx_commissions_created ON commissions(created_at);
```

### 3.9 策略信息表 (strategies)

存储用户策略基本信息（同步自客户端）。

| 字段名       | 类型         | 描述         | 索引 | 备注         |
| ------------ | ------------ | ------------ | ---- | ------------ |
| id           | UUID         | 策略UUID     | 主键 |              |
| user_id      | UUID         | 用户ID       | 外键 | 关联users    |
| name         | VARCHAR(100) | 策略名称     |      |              |
| exchange     | VARCHAR(50)  | 交易所       |      |              |
| trading_pair | VARCHAR(20)  | 交易对       |      |              |
| grid_type    | VARCHAR(20)  | 网格类型     |      |              |
| status       | VARCHAR(20)  | 状态         |      |              |
| created_at   | TIMESTAMP    | 创建时间     |      |              |
| last_updated | TIMESTAMP    | 最后更新时间 |      |              |
| is_deleted   | BOOLEAN      | 是否删除     |      | 逻辑删除标记 |

创建语句：
```sql
CREATE TABLE strategies (
    id UUID PRIMARY KEY,
    user_id UUID NOT NULL,
    name VARCHAR(100) NOT NULL,
    exchange VARCHAR(50) NOT NULL,
    trading_pair VARCHAR(20) NOT NULL,
    grid_type VARCHAR(20) NOT NULL,
    status VARCHAR(20) NOT NULL,
    created_at TIMESTAMP NOT NULL,
    last_updated TIMESTAMP NOT NULL DEFAULT NOW(),
    is_deleted BOOLEAN NOT NULL DEFAULT FALSE,
    FOREIGN KEY (user_id) REFERENCES users(id)
);

CREATE INDEX idx_strategies_user ON strategies(user_id);
CREATE INDEX idx_strategies_status ON strategies(status);
```

### 3.10 交易记录表 (trades)

存储用户上报的交易记录（同步自客户端）。

| 字段名      | 类型          | 描述     | 索引 | 备注           |
| ----------- | ------------- | -------- | ---- | -------------- |
| id          | UUID          | 交易UUID | 主键 |                |
| user_id     | UUID          | 用户ID   | 外键 | 关联users      |
| strategy_id | UUID          | 策略ID   | 外键 | 关联strategies |
| trade_type  | VARCHAR(10)   | 交易类型 |      | "buy"/"sell"   |
| price       | DECIMAL(20,8) | 成交价格 |      |                |
| amount      | DECIMAL(20,8) | 成交数量 |      |                |
| value       | DECIMAL(20,8) | 成交价值 |      |                |
| fee         | DECIMAL(20,8) | 手续费   |      |                |
| profit      | DECIMAL(20,8) | 盈亏金额 |      |                |
| executed_at | TIMESTAMP     | 执行时间 |      |                |
| recorded_at | TIMESTAMP     | 记录时间 |      |                |

创建语句：
```sql
CREATE TABLE trades (
    id UUID PRIMARY KEY,
    user_id UUID NOT NULL,
    strategy_id UUID NOT NULL,
    trade_type VARCHAR(10) NOT NULL,
    price DECIMAL(20,8) NOT NULL,
    amount DECIMAL(20,8) NOT NULL,
    value DECIMAL(20,8) NOT NULL,
    fee DECIMAL(20,8) NOT NULL,
    profit DECIMAL(20,8),
    executed_at TIMESTAMP NOT NULL,
    recorded_at TIMESTAMP NOT NULL DEFAULT NOW(),
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (strategy_id) REFERENCES strategies(id)
);

CREATE INDEX idx_trades_user ON trades(user_id);
CREATE INDEX idx_trades_strategy ON trades(strategy_id);
CREATE INDEX idx_trades_executed ON trades(executed_at);
```

### 3.11 用户偏好设置表 (user_preferences)

存储用户界面和通知偏好。

| 字段名              | 类型        | 描述             | 索引      | 备注                    |
| ------------------- | ----------- | ---------------- | --------- | ----------------------- |
| id                  | UUID        | 设置UUID         | 主键      |                         |
| user_id             | UUID        | 用户ID           | 外键,唯一 | 关联users               |
| theme               | VARCHAR(20) | 主题             |           | "light"/"dark"/"system" |
| language            | VARCHAR(10) | 语言             |           | "zh"/"en"等             |
| timezone            | VARCHAR(50) | 时区             |           | 例如"Asia/Shanghai"     |
| email_notifications | BOOLEAN     | 邮件通知         |           |                         |
| trade_notifications | BOOLEAN     | 交易通知         |           |                         |
| strategy_alerts     | BOOLEAN     | 策略警报         |           |                         |
| system_alerts       | BOOLEAN     | 系统警报         |           |                         |
| dashboard_layout    | TEXT        | 仪表盘布局(JSON) |           |                         |
| created_at          | TIMESTAMP   | 创建时间         |           |                         |
| updated_at          | TIMESTAMP   | 更新时间         |           |                         |

创建语句：
```sql
CREATE TABLE user_preferences (
    id UUID PRIMARY KEY,
    user_id UUID NOT NULL UNIQUE,
    theme VARCHAR(20) NOT NULL DEFAULT 'light',
    language VARCHAR(10) NOT NULL DEFAULT 'en',
    timezone VARCHAR(50) NOT NULL DEFAULT 'UTC',
    email_notifications BOOLEAN NOT NULL DEFAULT TRUE,
    trade_notifications BOOLEAN NOT NULL DEFAULT TRUE,
    strategy_alerts BOOLEAN NOT NULL DEFAULT TRUE,
    system_alerts BOOLEAN NOT NULL DEFAULT TRUE,
    dashboard_layout TEXT,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

### 3.12 通知表 (notifications)

存储系统和用户通知。

| 字段名     | 类型         | 描述           | 索引 | 备注                               |
| ---------- | ------------ | -------------- | ---- | ---------------------------------- |
| id         | UUID         | 通知UUID       | 主键 |                                    |
| user_id    | UUID         | 用户ID         | 外键 | 关联users，可为NULL表示系统通知    |
| type       | VARCHAR(20)  | 通知类型       |      | "info"/"success"/"warning"/"error" |
| title      | VARCHAR(100) | 标题           |      |                                    |
| message    | TEXT         | 消息内容       |      |                                    |
| is_read    | BOOLEAN      | 是否已读       |      |                                    |
| data       | TEXT         | 额外数据(JSON) |      |                                    |
| created_at | TIMESTAMP    | 创建时间       |      |                                    |
| read_at    | TIMESTAMP    | 阅读时间       |      | 可为NULL                           |

创建语句：
```sql
CREATE TABLE notifications (
    id UUID PRIMARY KEY,
    user_id UUID,
    type VARCHAR(20) NOT NULL,
    title VARCHAR(100) NOT NULL,
    message TEXT NOT NULL,
    is_read BOOLEAN NOT NULL DEFAULT FALSE,
    data TEXT,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    read_at TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    notification_category VARCHAR(50),  -- "trade", "system", "billing", etc.
    importance VARCHAR(20),  -- "high", "medium", "low"
    action_url VARCHAR(255),  -- 通知关联的操作URL
    action_taken BOOLEAN DEFAULT FALSE  -- 用户是否执行了通知建议的操作
);

CREATE INDEX idx_notifications_user ON notifications(user_id);
CREATE INDEX idx_notifications_read ON notifications(is_read);
CREATE INDEX idx_notifications_created ON notifications(created_at);
```

- `notification_category VARCHAR(50)` - 用于分类通知（交易、系统、账单等）
- `importance VARCHAR(20)` - 指定通知重要性级别（高、中、低）
- `action_url VARCHAR(255)` - 通知相关的操作链接
- `action_taken BOOLEAN` - 跟踪用户是否执行了通知建议的操作

这些额外字段增强了通知系统的功能性，使其能够更好地支持UI中的通知中心与提醒功能，特别是对于不同类型和重要程度的通知进行区分和处理。

### 3.13 系统设置表 (system_settings)

存储全局系统配置。

| 字段名      | 类型        | 描述     | 索引 | 备注                 |
| ----------- | ----------- | -------- | ---- | -------------------- |
| key         | VARCHAR(50) | 设置键   | 主键 |                      |
| value       | TEXT        | 设置值   |      |                      |
| description | TEXT        | 描述     |      |                      |
| is_public   | BOOLEAN     | 是否公开 |      | 是否可被非管理员查看 |
| created_at  | TIMESTAMP   | 创建时间 |      |                      |
| updated_at  | TIMESTAMP   | 更新时间 |      |                      |
| updated_by  | UUID        | 更新人ID | 外键 | 关联users            |

创建语句：
```sql
CREATE TABLE system_settings (
    key VARCHAR(50) PRIMARY KEY,
    value TEXT NOT NULL,
    description TEXT,
    is_public BOOLEAN NOT NULL DEFAULT FALSE,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_by UUID,
    FOREIGN KEY (updated_by) REFERENCES users(id)
);

CREATE INDEX idx_settings_public ON system_settings(is_public);
```

## 4. 数据同步结构

### 4.1 数据同步表 (sync_records)

记录客户端与服务端之间的数据同步状态。

| 字段名            | 类型        | 描述           | 索引 | 备注                         |
| ----------------- | ----------- | -------------- | ---- | ---------------------------- |
| id                | UUID        | 同步记录UUID   | 主键 |                              |
| user_id           | UUID        | 用户ID         | 外键 | 关联users                    |
| entity_type       | VARCHAR(50) | 实体类型       |      | "strategy"/"trade"           |
| entity_id         | UUID        | 实体ID         |      |                              |
| client_updated_at | TIMESTAMP   | 客户端更新时间 |      |                              |
| server_updated_at | TIMESTAMP   | 服务端更新时间 |      |                              |
| sync_status       | VARCHAR(20) | 同步状态       |      | "success"/"failed"/"pending" |
| sync_message      | TEXT        | 同步消息       |      | 错误信息等                   |
| created_at        | TIMESTAMP   | 创建时间       |      |                              |

创建语句：
```sql
CREATE TABLE sync_records (
    id UUID PRIMARY KEY,
    user_id UUID NOT NULL,
    entity_type VARCHAR(50) NOT NULL,
    entity_id UUID NOT NULL,
    client_updated_at TIMESTAMP NOT NULL,
    server_updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
    sync_status VARCHAR(20) NOT NULL,
    sync_message TEXT,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    FOREIGN KEY (user_id) REFERENCES users(id)
);

CREATE INDEX idx_sync_user_entity ON sync_records(user_id, entity_type);
CREATE INDEX idx_sync_status ON sync_records(sync_status);
```

## 5. 数据库关系图

```
                            ┌───────────────┐
                            │    users      │
                            └───────┬───────┘
                                    │
        ┌───────────────────┬───────┼───────┬───────────────┬─────────────┐
        │                   │               │               │             │
┌───────▼─────┐     ┌───────▼────┐  ┌───────▼───────┐ ┌─────▼─────┐ ┌─────▼─────┐
│   agents    │     │ strategies │  │account_balances│ │ invoices  │ │   trades  │
└───────┬─────┘     └────────────┘  └───────────────┘ └─────┬─────┘ └───────────┘
        │                                                   │
        │                                                   │
┌───────▼─────┐                                      ┌─────▼──────────┐
│ commissions │                                      │ invoice_details │
└─────────────┘                                      └─────────────────┘
```

## 6. 安全考虑

### 6.1 敏感数据保护

1. **API密钥安全**
   - API密钥（key, secret, passphrase）在客户端本地使用加密存储
   - 使用AES-256-GCM等强加密算法
   - 密钥派生使用Argon2或PBKDF2算法，结合用户主密码和安全盐值
   - API密钥不上传到服务端

2. **用户密码安全**
   - 服务端使用Django内置的PBKDF2+SHA256密码哈希
   - 使用高迭代次数增加破解难度
   - 每个用户使用唯一的盐值

3. **传输安全**
   - 所有API通信使用TLS 1.3加密
   - 使用证书固定(Certificate Pinning)防止中间人攻击
   - 敏感数据使用额外端到端加密

### 6.2 审计与日志

1. **服务端审计日志**
   - 记录所有敏感操作(登录、API密钥操作、权限变更等)
   - 包含用户ID、时间戳、IP地址、操作类型和结果
   - 日志不可篡改，使用安全存储

2. **客户端操作日志**
   - 记录本地执行的重要操作，便于问题诊断
   - 避免记录敏感信息如API密钥内容
   - 定期清理过期日志

## 7. 扩展性考虑

1. **分区策略**
   - 对大表(如交易记录、日志)使用时间分区
   - 对多租户数据考虑按用户ID分区

2. **索引优化**
   - 根据实际查询模式优化索引
   - 考虑部分索引和函数索引用于复杂查询
   - 对大表考虑使用并行索引构建

3. **未来扩展**
   - 设计支持添加新币种交易对
   - 考虑新的网格策略类型
   - 预留扩展字段（如JSON类型字段）

## 8. 性能优化

1. **查询优化**
   - 使用适当的复合索引减少IO
   - 大量数据查询使用分页和游标
   - 使用合理的缓存策略

2. **批量操作**
   - 数据同步使用批量插入
   - 定期批量分析和优化表

3. **长期数据管理**
   - 历史数据归档策略
   - 定期聚合统计数据，减少原始数据查询

## 结论

本数据模型设计为加密货币网格交易系统提供了全面的数据存储解决方案，既严格区分了客户端和服务端的数据职责，又确保了两者之间的协同工作。通过精心设计的表结构和关系，系统可以高效地支持网格交易策略的执行、风险控制、账户管理、计费结算和代理分润等核心功能。此设计还充分考虑了安全性、性能和可扩展性，为系统的稳定运行和未来发展奠定了坚实的基础。

### 3. 风控模板功能

风控设置UI中可能需要保存和应用风控模板。

```sql
CREATE TABLE risk_control_templates (
    id UUID PRIMARY KEY,
    user_id UUID NOT NULL,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    template_type VARCHAR(20) NOT NULL,  -- "system", "user"
    conditions TEXT NOT NULL,  -- JSON格式存储风控条件
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

### 4. 策略组管理功能

策略管理UI支持批量操作功能（批量启动/停止），可能需要策略组相关数据结构。

```sql
CREATE TABLE local_strategy_groups (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    description TEXT,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE local_strategy_group_members (
    group_id TEXT NOT NULL,
    strategy_id TEXT NOT NULL,
    added_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (group_id, strategy_id),
    FOREIGN KEY (group_id) REFERENCES local_strategy_groups(id),
    FOREIGN KEY (strategy_id) REFERENCES local_strategies(id)
);
```

### 6. 代理申请和审核流程支持

```sql
CREATE TABLE agent_applications (
    id UUID PRIMARY KEY,
    user_id UUID NOT NULL UNIQUE,
    application_status VARCHAR(20) NOT NULL,  -- "pending", "approved", "rejected"
    application_reason TEXT,
    requested_level INTEGER NOT NULL,
    admin_notes TEXT,
    reviewed_by UUID,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (reviewed_by) REFERENCES users(id)
);
```

### 7. 系统操作日志完善

服务端系统级别的操作日志表，用于记录管理操作。

```sql
CREATE TABLE admin_action_logs (
    id UUID PRIMARY KEY,
    admin_id UUID NOT NULL,
    action_type VARCHAR(50) NOT NULL,
    entity_type VARCHAR(50) NOT NULL,
    entity_id UUID,
    details TEXT,
    ip_address VARCHAR(45),
    user_agent TEXT,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    FOREIGN KEY (admin_id) REFERENCES users(id)
);
```

### 8. WebSocket实时数据支持

UI设计中有实时数据更新需求，数据模型WebSocket连接管理相关表。

```sql
CREATE TABLE websocket_connections (
    id UUID PRIMARY KEY,
    user_id UUID NOT NULL,
    connection_id VARCHAR(100) NOT NULL UNIQUE,
    client_info TEXT,
    subscribed_channels TEXT,  -- JSON格式存储订阅的频道
    connected_at TIMESTAMP NOT NULL DEFAULT NOW(),
    last_activity_at TIMESTAMP NOT NULL DEFAULT NOW(),
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

## 结论

总体而言，提供的数据模型设计能够支持UI设计中展示的大部分功能，结构合理且安全性考虑充分。通过添加上述建议的表和字段，可以完全满足UI设计的所有功能需求。特别是对于第三方登录、用户头像、风控模板和策略组管理等功能的数据支持需要补充。

这些修改和补充并不影响现有数据模型的整体架构和设计原则，可以作为现有设计的扩展来实现。随着系统功能的不断丰富，可能还需要进一步演进数据模型，但目前的设计为此提供了良好的基础。