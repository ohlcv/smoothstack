# AI助手状态维护机制

## 背景

在开发CryptoSystem项目过程中，我们发现AI助手可能因为会话断开或其他原因导致上下文丢失，失去对项目的理解把握和对工作流程的执行能力。这会导致开发跑偏、效率降低和不一致的建议。为解决这个问题，我们设计了一套状态维护机制。

## 口令机制

### 状态正常口令

每次回复时，AI助手都会在消息结尾添加固定口令：

```
[CGB-状态正常]
```

这个口令表示AI助手当前正处于正确的工作状态，对项目有清晰的理解和把握。

### 状态检查

如果用户发现AI助手的回复中没有包含状态正常口令，那么即表明AI助手可能已经丢失上下文或状态异常，需要进行状态恢复。

## 文档体系

为支持状态恢复，我们建立了以下文档体系：

### 1. 恢复指南

**位置**：`docs/assistant_work/恢复指南.md`

**内容**：
- 快速恢复步骤
- 关键文档位置
- 重要概念速览
- 工作流程要点
- 常见问题解决方案

当AI助手状态异常时，用户可以指示AI助手查看此文档，快速恢复对项目的理解。

### 2. 项目状态

**位置**：`docs/assistant_work/项目状态.md`

**内容**：
- 项目概述
- 当前开发进度
- 关键组件状态
- 技术债务
- 下一步计划

此文档实时反映项目的最新状态，帮助AI助手了解当前的开发进展和重点任务。

### 3. 工作日志

**位置**：`docs/assistant_work/工作日志/`目录下按日期命名的文件

**内容**：
- 每日完成的工作
- 遇到的问题和解决方案
- 学习的经验和教训
- 下一步工作计划

这些日志记录了详细的工作过程和经验，是恢复状态的重要参考资料。

### 4. 经验积累

**位置**：`docs/assistant_work/经验积累/`目录下按主题组织的文件

**内容**：
- 开发经验和最佳实践
- 常见问题解决方案
- 技术研究和探索
- 工作流程优化建议

这些文档沉淀了项目开发过程中的宝贵经验，帮助AI助手避免重复犯错。

## 状态维护流程

### 1. 日常更新

- 完成重要功能后，更新相关工作日志
- 项目状态发生变化时，更新项目状态文档
- 积累新的经验后，更新经验积累文档

### 2. 状态异常处理

当发现AI助手状态异常时，用户可采取以下步骤：

1. 告知AI助手状态异常
2. 指示AI助手查看恢复指南文档
3. 根据需要指示查看其他相关文档
4. 确认AI助手是否已恢复状态（通过口令检查）

### 3. 定期检查

即使没有明显的状态异常，也建议定期进行以下检查：

- 在开始新功能开发前，确认AI助手对项目状态的理解
- 遇到复杂问题时，先确认AI助手的状态是否正常
- 长时间会话后，检查AI助手是否保持正确状态

## 最佳实践

1. **文档优先**：遇到问题先查文档，避免重复解释
2. **及时记录**：完成工作后立即更新相关文档
3. **关注口令**：始终关注每次回复中的状态口令
4. **增量恢复**：状态恢复采用从重要到次要的顺序
5. **定期总结**：定期总结和更新项目状态，保持文档的时效性
6. **文件操作验证**：每次创建或编辑文件后，立即验证内容是否正确写入

## 文件操作验证的重要性

根据项目经验，文件操作可能看似成功但实际内容未写入，因此我们必须：

1. **立即验证**：每次文件操作后立即验证内容
2. **分段处理**：大型文档分段创建和编辑
3. **多种备份**：重要内容使用多种方法备份
4. **失败重试**：发现写入失败时立即采取备选方案

## 结论

通过建立状态维护机制和配套文档体系，我们可以有效解决AI助手状态丢失的问题，确保开发过程的连贯性和一致性。这种机制不仅提高了开发效率，也沉淀了宝贵的项目经验和知识。同时，我们必须谨记文件操作验证的重要性，确保所有文档更新都被正确保存。

## 概述

在大型项目开发过程中，AI助手需要有效维护状态信息，确保跨会话的连贯性和一致性。本文档总结了状态维护机制的关键经验。

## 核心经验

### 1. 会话状态维护的重要性

AI助手需要维护多个层次的状态信息，包括：

- **短期工作状态**：当前任务、上下文、进度
- **中期项目记忆**：关键决策、项目结构、重要变更
- **长期知识沉淀**：技术选型理由、架构演进、经验教训

没有良好的状态维护机制，AI助手将无法提供连贯的支持，导致重复工作、错误决策和效率低下。

### 2. 采用ai_workspace目录结构

我们采用标准的`ai_workspace`目录结构来维护AI助手状态：

```
ai_workspace/
├── session_history/      # 会话历史记录
├── memory/               # 记忆存储
├── contextual_awareness/ # 上下文意识
└── project_state/        # 项目状态
```

### 3. 会话历史记录管理

每次有意义的会话应记录到`session_history`目录下，按日期命名，包含：

- 会话概述
- 主要工作内容
- 关键决策
- 遇到的问题
- 下一步计划

### 4. 项目记忆维护

在`memory`目录下创建`project_memory.md`存储核心项目信息：

- 项目核心目标
- 技术栈选择
- 架构关键点
- 重要决策记录
- 关键文件位置

### 5. 上下文意识构建

在`contextual_awareness`目录下，维护当前的环境和背景信息：

- 项目背景
- 当前开发环境
- 用户需求和目标
- 已识别的关键点
- 外部环境因素

### 6. 项目状态跟踪

在`project_state`目录下，维护当前项目状态：

- 最后更新时间
- 当前阶段
- 已完成工作
- 进行中工作
- 下一步计划
- 技术债务

## 关键教训

### 教训1：状态丢失风险

**问题**：跨会话后，AI助手忘记前序决策和上下文

**解决方案**：每个关键决策后立即更新`project_memory.md`，确保记录永久保存

### 教训2：目录结构重要性

**问题**：没有标准化的目录结构导致信息散乱

**解决方案**：严格遵循`ai_workspace`目录规范，确保信息有序存储

### 教训3：状态维护缺失导致工作流断裂

**问题**：在大型项目中忘记创建和维护`ai_workspace`，导致项目连贯性缺失，无法追踪项目状态和关键决策

**解决方案**：
1. 在项目初始化阶段立即创建`ai_workspace`目录结构
2. 每次会话结束前，检查并更新相关状态文件
3. 在工作流中明确定义状态维护责任
4. 添加自动检查机制，确保ai_workspace目录存在并正确维护
5. 在交接班或任务切换时，优先回顾ai_workspace中的状态信息

**预防措施**：
- 每次会话开始时，优先检查`ai_workspace`目录是否存在
- 如不存在，立即创建并补充基本状态信息
- 定期审查状态文件的完整性和准确性
- 开发状态维护检查清单，确保无遗漏

## 提示词模板

### 状态维护提示词

```
根据大型项目开发工作流，请检查ai_workspace目录是否存在并正确维护。如不存在或状态文件不完整，请：
1. 创建标准ai_workspace目录结构（会话历史/记忆/上下文意识/项目状态）
2. 基于当前项目状态，创建或更新以下文件：
   - project_state/current_state.md：记录当前项目阶段和进度
   - memory/project_memory.md：记录项目核心信息和关键决策
   - contextual_awareness/context_[日期].md：记录当前环境和背景
   - session_history/session_[日期].md：记录本次会话内容
3. 确保所有状态文件格式规范，信息准确完整
```

### 会话开始提示词

```
在开始今天的工作前，请先检查ai_workspace状态：
1. ai_workspace目录是否存在并包含完整子目录
2. 项目状态文件是否反映最新进展
3. 项目记忆是否包含所有关键决策
请根据检查结果，维护或更新相关状态文件，然后简要汇报当前项目状态和今天的工作重点。
```

### 会话结束提示词

```
在结束今天的工作前，请更新ai_workspace中的状态文件：
1. 在session_history中记录今天的工作内容和决策
2. 更新project_state反映最新进展
3. 如有重要决策，更新project_memory
4. 确认所有状态文件内容一致且准确
请完成这些更新后，总结今天的工作成果和明天的计划。
``` 